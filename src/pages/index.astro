---
import Root from "../layouts/root.astro";

const EXPEDITIONS = [
  {
    name: "blue",
    background: { checked: "aria-checked:bg-blue-400" },
    text: "text-blue-400",
    border: "border-blue-400",
  },
  {
    name: "yellow",
    background: { checked: "aria-checked:bg-yellow-400" },
    text: "text-yellow-400",
    border: "border-yellow-400",
  },
  {
    name: "gray",
    background: { checked: "aria-checked:bg-gray-200" },
    text: "text-gray-200",
    border: "border-gray-200",
  },
  {
    name: "green",
    background: { checked: "aria-checked:bg-green-400" },
    text: "text-green-400",
    border: "border-green-400",
  },
  {
    name: "red",
    background: { checked: "aria-checked:bg-red-400" },
    text: "text-red-400",
    border: "border-red-400",
  },
];

const WAGERS = [1, 2, 3];

const SCORES = [2, 3, 4, 5, 6, 7, 8, 9, 10];
---

<script>
  import Alpine from "alpinejs";

  const EXPEDITION_COST = 20;

  Alpine.data("expedition", () => ({
    get size() {
      return this.wagers.size + this.scores.size;
    },

    get bonus() {
      return this.size >= 8 ? 20 : 0;
    },

    get multiplier() {
      return this.wagers.size + 1;
    },

    wagers: new Set<number>(),
    toggleWager(wager: number) {
      // uncheck higher wagers
      if (wager < this.wagers.size) {
        for (const index of this.wagers) {
          if (index > wager) {
            this.wagers.delete(index);
          }
        }
      }

      // check all wagers up to the selected one
      else if (wager > this.wagers.size) {
        for (let index = 0; index < wager; index++) {
          this.wagers.add(index + 1);
        }
      }

      // uncheck all wagers up from the selected one
      else {
        for (const index of this.wagers) {
          if (index >= wager) {
            this.wagers.delete(index);
          }
        }
      }
    },

    scores: new Set<number>(),
    toggleScore(score: number) {
      if (this.scores.has(score)) {
        this.scores.delete(score);
      } else {
        this.scores.add(score);
      }
    },

    get scoresSum() {
      return Array.from(this.scores).reduce((acc, score) => acc + score, 0);
    },

    get totalScore() {
      if (this.size === 0) {
        return 0;
      }

      return (this.scoresSum - EXPEDITION_COST) * this.multiplier + this.bonus;
    },

    get totalScoreHint() {
      if (this.size === 0) {
        return [];
      }

      const scores =
        this.scores.size === 0
          ? "0"
          : Array.from(this.scores)
              .sort((left, right) => left - right)
              .join(" + ");

      return [
        this.multiplier > 1 ? `${this.multiplier} √ó ` : "",
        "(",
        scores,
        ` - ${EXPEDITION_COST}`,
        ")",
        this.bonus > 0 ? ` + ${this.bonus}` : "",
      ]
        .filter((fragment) => fragment.length > 0)
        .join("");
    },
  }));
</script>
<Root>
  <div
    class="py-3"
    x-data={`{
      ${EXPEDITIONS.map(({ name }) => `${name}: expedition(),`).join("")}

      get total() {
        return ${EXPEDITIONS.map(({ name }) => `this.${name}.totalScore`).join(" + ")};
      },

      get totalDigits() {
        return Math.abs(this.total).toString().padStart(3, '0').split('');
      },

      get totalSign() {
        return this.total < 0 ? '-' : '+';
      },
    }`}
  >
    <table class="table table-sm text-center">
      <tbody>
        {
          WAGERS.map((wager) => (
            <tr>
              {EXPEDITIONS.map(({ name, background, border }) => (
                <td>
                  <button
                    name={`${name}-wager-${wager}`}
                    role="checkbox"
                    x-bind:aria-checked={`${name}.wagers.has(${wager})`}
                    x-on:click={`${name}.toggleWager(${wager})`}
                    class:list={[
                      "btn btn-square btn-xs",
                      border,
                      background.checked,
                    ]}
                  >
                    ü§ù
                  </button>
                </td>
              ))}
            </tr>
          ))
        }

        {
          SCORES.map((score) => (
            <tr>
              {EXPEDITIONS.map(({ name, text, border, background }) => (
                <td>
                  <button
                    name={`${name}-score-${score}`}
                    role="checkbox"
                    x-bind:aria-checked={`${name}.scores.has(${score})`}
                    x-on:click={`(${name}.toggleScore(${score}))`}
                    class:list={[
                      "btn btn-square btn-xs aria-checked:text-base-100",
                      text,
                      border,
                      background.checked,
                    ]}
                  >
                    {score}
                  </button>
                </td>
              ))}
            </tr>
          ))
        }

        <tfoot class="border-t-4">
          <tr>
            {
              EXPEDITIONS.map(({ name }, index, arr) => (
                <td>
                  <span
                    class="tooltip w-full select-none underline-offset-4 decoration-dotted"
                    x-bind:class={`${name}.totalScore === 0 ? 'cursor-default' : 'cursor-help underline'`}
                  >
                    <span
                      class:list={[
                        "tooltip-content",
                        index < 3 && "!left-0 !right-auto !transform-none",
                        index > arr.length - 3 &&
                          "!right-0 !left-auto !transform-none",
                      ]}
                      x-text={`${name}.totalScoreHint`}
                    />
                    <span x-text={`${name}.totalScore`} />
                  </span>

                  {index > 0 && (
                    <span class="absolute right-full inset-y-0 flex items-center">
                      +
                    </span>
                  )}
                </td>
              ))
            }
          </tr>
        </tfoot>
      </tbody>
    </table>

    <div class="mt-2 flex justify-center font-mono text-6xl">
      <span class="countdown countdown-sign">
        <span
          x-bind:style="'--value:' + Math.sign(total) + ';'"
          aria-live="polite"
          x-text="totalSign"
          x-bind:aria-label="totalSign"
        >
        </span>
      </span>

      <template x-for="digit of totalDigits">
        <span class="countdown countdown-digit">
          <span
            x-bind:style="'--value:' + digit + ';'"
            aria-live="polite"
            x-text="digit"
            x-bind:aria-label="digit"
          >
          </span>
        </span>
      </template>

      <!-- balance the digits in middle -->
      <span>&nbsp;</span>
    </div>
  </div>
</Root>
